<html>
    <head>
            <style>
                #aa{

                  width:150px;

                }
                .marker {
                    width: 30px;
                    height: 30px;
                    background-color: red;
                    position: absolute;
                }

                #markerMap {
                    position: relative;
                    z-index: 1;
                    float: left;
                }
                #regionMap{
                    position: absolute;
                    z-index: 0;
                }
            </style>
            <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
            <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">
            <script src="../../build/index.js"></script>
    </head>
    <body>
        <div>
          <div id='aa'>
            <table>
              <tbody>
                <tr>
                  <th><input id="work-hour" class="option" type='checkbox' ></input></th>
                  <th>Working Hour</th>

                </tr><tr>
                  <th><input id="pie-chart" class="option" type='checkbox' checked ></input></th>
                  <th>Pie Chart</th>

                </tr>
              </tbody>
            </table>
          </div>
        <div id="regionMap" style="width: 900px; height: 500px;"></div>
        <div id="markerMap" style="width: 900px; height: 500px;"></div>
        </div>
        <script type="text/javascript">

        var data1,k;


        $(".option").change(function() {
          if(document.getElementById('work-hour').checked)
          {
            google.charts.setOnLoadCallback(drawVisualization);
            google.charts.setOnLoadCallback(drawVisualizationMarker);
          }
          else {
            google.charts.setOnLoadCallback(drawVisualization);
            google.charts.setOnLoadCallback(drawVisualizationMarker);
          }
          if(document.getElementById('pie-chart').checked)
          {
            document.getElementById("markerMap").setAttribute("style","'display':'block'");
          }
          else
          {
            document.getElementById("markerMap").style.display = "none";
          }


});

        function checkNoFilter()
        {
          var noFilter = true;
          var options = document.getElementsByClassName("option");
          for (var i in options)
          {
            var element = options[i];
            //console.log(element);
            if (element.checked)
            {
              if (element.id != "pie-chart")
                noFilter = false;
            }
          }

          return noFilter;
        }


        var machines1 = [];
        getData();

        function getData(){

          $.get("https://prima-visual.herokuapp.com/country", function(data, status){
            data1 = data;

              populatePieChartDrawer();

              //load the maps
              google.charts.load('visualization', '1', { 'packages': ['geochart'] });
              google.charts.setOnLoadCallback(drawVisualization);

              google.charts.load('visualization', '1', { 'packages': ['geochart'] });
              google.charts.setOnLoadCallback(drawVisualizationMarker);
          });



          }

          function populatePieChartDrawer()
          {
            for (var i=0; i< data1.length;i++)
            {
              for (k in data1[i].machines ){
              var pieData = { values: [data1[i].machines[k].workingHour*100, data1[i].machines[k].failureHour*100, data1[i].machines[k].idleHour*100], colors: ['#EC4548', '#FD9133', '#7BE17F'], radius: 48, stroke: 4 };
              const _icon = 'data:image/svg+xml;charset=UTF-8,' + svgCharts().generatePieChartSVG(pieData.values, pieData.colors, pieData.radius, pieData.stroke);
              //console.log(pieData.values);
              machines1.push(_icon);
            }
          }


        }

          //draw region map
            function drawVisualization() {
                var data = new google.visualization.DataTable();
                data.addColumn('string', 'Country');
                data.addColumn('number', 'Resources');
                for (var i=0; i < data1.length;i++){
                  var value=0,j;
                  for (j in data1[i].machines ){
                      if (checkNoFilter())
                      {

                        value+=data1[i].machines[j].workingHour/data1[i].machines[j].workingDayHour;
                      }
                      else if(document.getElementById('work-hour').checked) {
                        value+=data1[i].machines[j].workingHour;
                      }

                      //console.log(value);
                    }
                  data.addRows([[{ v: data1[i].name, f: data1[i].name }, value]]);
                /*data.addRows([[{ v: 'USA', f: ' USA' }, 15]]);
                data.addRows([[{ v: 'Finland', f: 'Finland' }, 15]]);*/}
                var regionOptions = {
                    legend: 'none',
                    width: "600",
                    height: "400",
                    displayMode: "regions",
                     // orange to blue

                    sizeAxis: { minValue: 5, maxValue: 15, minSize: 5, maxSize: 15 },
                    region: 'world'
                };
                if (document.getElementById('work-hour').checked)
                {
                  regionOptions.colorAxis = {colors: ['#535B7F', '#4374e0']};
                }
                else {
                  regionOptions.colorAxis = {colors: ['#299904', '#4aff0f']};
                }



                var chartRegion = new google.visualization.GeoChart(document.getElementById('regionMap'));
                chartRegion.draw(data, regionOptions);

            }


            //draw marker map
            function drawVisualizationMarker() {
                var data = new google.visualization.DataTable();
                data.addColumn('string', 'Country');
                data.addColumn('number', 'Resources');
                for (var i=0; i < data1.length;i++){
                  var value=0,j;
                  for (j in data1[i].machines ){
                      value+=data1[i].machines[j].workingHour/data1[i].machines[j].workingDayHour;
                      //console.log(value);
                    }
                  data.addRows([[{ v: data1[i].name, f: data1[i].name }, 5]]);
                /*data.addRows([[{ v: 'USA', f: ' USA' }, 15]]);
                data.addRows([[{ v: 'Finland', f: 'Finland' }, 15]]);*/}
                var markerOptions = {
                    legend: 'none',
                    width: "600",
                    height: "400",

                    backgroundColor: 'transparent',
                    datalessRegionColor: 'transparent',

                    displayMode: "markers",

                    tooltip : false,
                    sizeAxis: { minValue: 5, maxValue: 15, minSize: 5, maxSize: 15 },
                    region: 'world'
                };


                var chart = new google.visualization.GeoChart(document.getElementById('markerMap'));
                google.visualization.events.addListener(chart, 'ready', function () {
                    var t;

                    for (t=0; t< 3;t++){

                    createMarkerImage("img", machines1[t]);
                    //console.log(document.getElementsByTagName('circle')[t]);
                    
                    document.getElementsByTagName('circle')[t].setAttribute("fill","url(#img)");
                  }
                });

                chart.draw(data, markerOptions);

            }






            function createMarkerImage(id, url) {
                var patt = document.createElementNS('http://www.w3.org/2000/svg', 'pattern');
                //console.log(url);
                patt.setAttribute('id', id);
                patt.setAttribute('width', '10');
                patt.setAttribute('height', '10');
                var image = document.createElementNS('http://www.w3.org/2000/svg', 'image');
                image.setAttributeNS('http://www.w3.org/1999/xlink', 'xlink:href', url);
                image.setAttribute('width', '10');
                image.setAttribute('height', '10');
                var defs = document.getElementsByTagName('defs')[0];
                patt.appendChild(image);
                defs.appendChild(patt);
            }
        </script>
    </body>
</html>
