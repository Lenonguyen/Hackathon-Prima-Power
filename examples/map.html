<html>
    <head>
            <style>
                .marker {
                    width: 30px;
                    height: 30px;
                    background-color: red;
                    position: absolute;
                }

                #markerMap {
                    position: relative;
                    z-index: 1;
                    float: left;
                }
                #regionMap{
                    position: absolute;
                    z-index: 0;
                }
            </style>
            <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
            <script src="../../build/index.js"></script>
    </head>
    <body>
        <div id="regionMap" style="width: 900px; height: 500px;"></div>
        <div id="markerMap" style="width: 900px; height: 500px;"></div>
        <script type="text/javascript">

        var data1,k;
        init();
        function init(){
          var request = new XMLHttpRequest();
          request.open("GET", "https://prima-visual.herokuapp.com/country", false);
          //var user_and_pass = document.getElementById("user").value + ":" +  document.getElementById("password").value;
          request.send();
          data1 = JSON.parse(request.responseText);
          //console.log(data1);
        }
        var machines1 = [];
          for (var i=0; i< data1.length;i++)
          {
            for (k in data1[i].machines ){
            var pieData = { values: [data1[i].machines[k].workingHour*100, data1[i].machines[k].failureHour*100, data1[i].machines[k].idleHour*100], colors: ['#EC4548', '#FD9133', '#7BE17F'], radius: 48, stroke: 4 };
            const _icon = 'data:image/svg+xml;charset=UTF-8,' + svgCharts().generatePieChartSVG(pieData.values, pieData.colors, pieData.radius, pieData.stroke);
            console.log(pieData.values);
            machines1.push(_icon);
          }
        }


google.charts.load('visualization', '1', { 'packages': ['geochart'] });
            google.charts.setOnLoadCallback(drawVisualization);

            function drawVisualization() {
                var data = new google.visualization.DataTable();
                data.addColumn('string', 'Country');
                data.addColumn('number', 'Resources');
                for (var i=0; i < data1.length;i++){
                  var value=0,j;
                  for (j in data1[i].machines ){
                      value+=data1[i].machines[j].workingHour/data1[i].machines[j].workingDayHour;
                      //console.log(value);
                    }
                  data.addRows([[{ v: data1[i].name, f: data1[i].name }, value]]);
                /*data.addRows([[{ v: 'USA', f: ' USA' }, 15]]);
                data.addRows([[{ v: 'Finland', f: 'Finland' }, 15]]);*/}
                var regionOptions = {
                    legend: 'none',
                    width: "600",
                    height: "400",
                    displayMode: "regions",
                    colorAxis: {colors: ['#535B7F', '#4374e0']}, // orange to blue

                    sizeAxis: { minValue: 5, maxValue: 15, minSize: 5, maxSize: 15 },
                    region: 'world'
                };


                var chartRegion = new google.visualization.GeoChart(document.getElementById('regionMap'));
                chartRegion.draw(data, regionOptions);

            }


            google.charts.load('visualization', '1', { 'packages': ['geochart'] });
            google.charts.setOnLoadCallback(drawVisualizationMarker);

            function drawVisualizationMarker() {
                var data = new google.visualization.DataTable();
                data.addColumn('string', 'Country');
                data.addColumn('number', 'Resources');
                for (var i=0; i < data1.length;i++){
                  var value=0,j;
                  for (j in data1[i].machines ){
                      value+=data1[i].machines[j].workingHour/data1[i].machines[j].workingDayHour;
                      //console.log(value);
                    }
                  data.addRows([[{ v: data1[i].name, f: data1[i].name }, 5]]);
                /*data.addRows([[{ v: 'USA', f: ' USA' }, 15]]);
                data.addRows([[{ v: 'Finland', f: 'Finland' }, 15]]);*/}
                var markerOptions = {
                    legend: 'none',
                    width: "600",
                    height: "400",

                    backgroundColor: 'transparent',
                    datalessRegionColor: 'transparent',
                    defaultColor: 'white',
                    displayMode: "markers",
                    colorAxis: {colors: ['#535B7F', '#4374e0']}, // orange to blue
                    tooltip : false,
                    sizeAxis: { minValue: 5, maxValue: 15, minSize: 5, maxSize: 15 },
                    region: 'world'
                };


                var chart = new google.visualization.GeoChart(document.getElementById('markerMap'));
                google.visualization.events.addListener(chart, 'ready', function () {
                    var t;

                    for (t=0; t< 3;t++){
                    var img = "#img";
                    createMarkerImage("img", machines1[t]);
                    console.log(document.getElementsByTagName('circle')[t]);
                    document.getElementsByTagName('circle')[t].setAttribute("fill","url(#img)");
                  }
                });

                chart.draw(data, markerOptions);

            }






            function createMarkerImage(id, url) {
                var patt = document.createElementNS('http://www.w3.org/2000/svg', 'pattern');
                console.log(url);
                patt.setAttribute('id', id);
                patt.setAttribute('width', '10');
                patt.setAttribute('height', '10');
                var image = document.createElementNS('http://www.w3.org/2000/svg', 'image');
                image.setAttributeNS('http://www.w3.org/1999/xlink', 'xlink:href', url);
                image.setAttribute('width', '10');
                image.setAttribute('height', '10');
                var defs = document.getElementsByTagName('defs')[0];
                patt.appendChild(image);
                defs.appendChild(patt);
            }
        </script>
    </body>
</html>
